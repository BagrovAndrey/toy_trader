# STATUS_3 — toy_trader (src-layout)

## Контекст
- Пользователь: профессор теоретической физики; хочет алгоритмического трейдера.
- Цель: постепенно дойти до live trading на Bybit spot, без "проекта на 2 года".
- Подход: маленькие шаги, каждый шаг — законченный коммит.

## Структура проекта
Repo layout: `toy_trader/{src, configs, docs, reports}`, код в `src/toy_trader/`.
Скрипты запуска находятся в `src/` (например `run_backtest.py`).

## Архитектура (pipeline)
DataSource -> MarketData -> Strategy -> Signals -> ExecutionModel -> PortfolioState -> Reporting/Viz
- Signal = target position (целевое состояние), а не команды buy/sell.
- Engine — оркестратор, без логики торговли.

## Реализовано (фактически работает)
### Types (src/toy_trader/core_types.py)
- MarketData: {bars: DataFrame, symbol: str}
  bars: DatetimeIndex ascending; cols: Open, High, Low, Close, Volume
- Signals: target_position: Series (index совместим с bars.index), значения 0/1 (long-only MVP)
- Fill: {symbol, ts, price, qty:int, fee}
- PortfolioState: {cash, positions: Dict[symbol,int], last_prices: Dict[symbol,float], equity}
  Multi-asset структура уже есть через dict.

### Data sources (src/toy_trader/data_sources.py)
- YahooDataSource.get_bars() реализован через yfinance:
  - возвращает MarketData с колонками Open/High/Low/Close/Volume
  - индекс DatetimeIndex, монотонно возрастающий
  - косметика: желательно сбросить bars.columns.name (иногда "Price") в None
- CSVDataSource пока заглушка.

### Strategy (src/toy_trader/strategies.py)
- SMACrossStrategy.generate_signals() реализован:
  - SMA fast/slow по Close
  - target_position = 1 если SMA_fast > SMA_slow иначе 0
  - применяется shift_for_execution (лаг "на следующий бар") в стратегии
  - NaN -> 0

### Execution (src/toy_trader/execution.py)
- NextBarExecutionModel.run() реализован:
  - вход: MarketData, Signals, initial PortfolioState
  - проверка: индексы сигналов и баров должны совпадать (иначе ValueError)
  - интерпретация: target_position ∈ {0,1} => desired_qty ∈ {0,1} unit
  - сделка только при смене desired_qty (delta != 0)
  - цена исполнения: Open/Close текущего бара (params.fill_price)
  - slippage: buy дороже, sell дешевле (bps)
  - fee: bps от notional
  - обновляет cash, positions, last_prices (mark-to-market по Close), equity
  - states: сохраняется snapshot PortfolioState на каждом баре (копии dict)

### Engine (src/toy_trader/engine.py)
- BacktestEngine.run() работает end-to-end и возвращает BacktestResult
  (market_data, signals, fills, states)

## Проверено руками (REPL)
- YahooDataSource возвращает корректный MarketData (колонки, DatetimeIndex, monotonic).
- SMACrossStrategy генерирует Series без NaN после fillna, с 0/1.
- Execution выдаёт fills/states; states длиной = числу баров.
- Сформирован скрипт отчёта/визуализации: отдельный файл (например run_report.py) рекомендуется.

## Визуализация и метрики (MVP)
- Важно: сейчас sizing = 1 unit. Поэтому сравнение "equity в процентах от initial_cash" зависит от initial_cash
  и некорректно сравнивать с buy&hold "на весь капитал".
- Корректный baseline для текущей модели: сравнивать PnL стратегии ($) vs PnL buy&hold 1 share ($).

Рекомендуемый отдельный скрипт:
- `src/run_report.py`: запускает backtest и строит:
  - price + indicator position
  - pnl_strategy ($) vs pnl_buyhold_1 ($)
  - печатает базовые метрики (если есть reporting.py)

## Принятые решения
- Lag исполнения сейчас реализован в стратегии (shift_for_execution), execution исполняет на текущем баре.
- MVP: long-only, 0/1 target position, 1 unit sizing.
- Требование: код должен естественно расширяться на multi-asset (уже учитывается через dict в PortfolioState).

## Следующий шаг (одобрен)
Переход на дробные позиции (для крипты spot Bybit):
- заменить qty и positions с int на float или Decimal:
  - Fill.qty: float/Decimal
  - PortfolioState.positions: Dict[str, float/Decimal]
- убрать int() касты в execution, добавить epsilon-обнуление для near-zero.
- после этого: добавить position sizing (например all-in или notional-based), затем broker adapter (Bybit spot).

## Команды запуска (с нуля)
Из `toy_trader/src`:
- REPL:
  python
  (далее: собрать YahooDataSource + SMACrossStrategy + NextBarExecutionModel + BacktestEngine и engine.run())
- Скрипты:
  python run_backtest.py
  python run_report.py   (если создан)

## Notes
- Проект использует src-layout; запускать нужно так, чтобы `src/` был рабочей директорией или в PYTHONPATH.
