# STATUS_4 — toy_trader (A1–A3 complete, next: allocation)

## Контекст
- Цель: пошагово дойти до live trading на Bybit spot.
- Подход: маленькие, законченные коммиты. Research → realistic sim → paper → live.
- Архитектура: Signals = target state (позиция/доля), Engine = оркестратор.

## Repo layout
`toy_trader/{src, configs, docs, reports}`
Код: `src/toy_trader/`
Скрипты: `src/run_backtest.py`, `src/run_report.py`, `src/run_report_multi.py`

## Pipeline (single-asset)
DataSource -> MarketData -> Strategy -> Signals(target_fraction) -> Execution -> PortfolioState -> Reporting

## Реализовано

### A1 — Position sizing (DONE)
- `Signals.target_position` трактуется как **target_fraction ∈ [0,1]** (long-only).
- Execution переводит fraction -> desired_qty через equity/Close (sizing по Close).
- Execution учитывает комиссии/проскальзывание и ограничение **no-overspend** для spot (покупка не тратит больше наличных с учётом fee).
- Cash "пыль" зануляется eps-клампом.

### A2 — Reporting & metrics (DONE)
- `toy_trader/reporting.py`:
  - `equity_curve(res)` (single-asset)
  - `drawdown_curve(eq)`, `max_drawdown(eq)`
  - `metrics_from_equity(eq, num_trades=...)` -> `BasicMetrics`
  - `basic_metrics(res)` (single-asset convenience)
- Annualization: **calendar-based (24/7)**, подходит для крипты.
- `run_report.py`:
  - корректный baseline **buy&hold all-in** (на тот же initial_cash)
  - графики: price+позиция, PnL strategy vs buy&hold, equity, drawdown
  - sanity-check: cash не уходит существенно в минус

### A3 — Multi-asset (DONE, технический слой)
- `toy_trader/multi_data_sources.py`:
  - `MultiYahooDataSource(symbols=[...])` -> `MultiMarketData`
  - выравнивание данных по **пересечению DatetimeIndex**
- `toy_trader/multi_execution.py`:
  - `MultiNextBarExecutionModel` исполняет сигналы на общем таймлайне
  - общий `PortfolioState` (cash общий; positions/last_prices по символам)
  - per-symbol sizing через equity/Close
  - no-overspend на покупках, eps
- `toy_trader/multi_engine.py`:
  - `MultiBacktestEngine` генерирует сигналы по каждому символу и исполняет multi-run
- `run_report_multi.py`:
  - multi-asset отчёт: equity, drawdown, qty по каждому символу
  - метрики через `metrics_from_equity(eq, num_trades=len(fills))`

## Важно: текущая семантика multi-asset
- Сейчас `target_fraction` задаётся **независимо по каждому символу** (per-asset).
- Нет портфельной нормализации: суммарная экспозиция не контролируется (`Σ fractions` может быть > 1) из-за независимых сигналов и последовательного исполнения.
- Это осознанное упрощение A3: “multi-asset технически работает”.

## Следующий шаг (planned): Allocation layer
Добавить уровень Portfolio Construction / Allocation:
- нормализация долей по активным сигналам (например, equal-weight, capped weights)
- гарантия `Σ target_fraction ≤ 1`
- опционально: risk parity / vol targeting / max weight per asset
- затем обновить multi-execution, чтобы исполнять **уже портфельные** target weights.

## Команды запуска
Из `toy_trader/src`:
- single:
  - `python run_report.py`
- multi:
  - `python run_report_multi.py`
